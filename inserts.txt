criar uma pasta temp e colocar o dataset limpo la 

\COPY epidemiologia.staging_dados FROM 'C:/temp/dataset_limpo - dataset_limpo (1).csv' DELIMITER ',' CSV HEADER;




-- Dimensões de Texto Simples
INSERT INTO epidemiologia.sexo (nome)
SELECT DISTINCT TRIM(LOWER(sexo)) FROM epidemiologia.staging_dados
WHERE sexo IS NOT NULL AND TRIM(sexo) <> ''
ON CONFLICT (nome) DO NOTHING;

INSERT INTO epidemiologia.raca (nome)
SELECT DISTINCT TRIM(LOWER(racacor)) FROM epidemiologia.staging_dados
WHERE racacor IS NOT NULL AND TRIM(racacor) <> ''
ON CONFLICT (nome) DO NOTHING;

INSERT INTO epidemiologia.evolucao (nome)
SELECT DISTINCT TRIM(LOWER(evolucaocaso)) FROM epidemiologia.staging_dados
WHERE evolucaocaso IS NOT NULL AND TRIM(evolucaocaso) <> ''
ON CONFLICT (nome) DO NOTHING;

INSERT INTO epidemiologia.classificacao (nome)
SELECT DISTINCT TRIM(LOWER(classificacaofinal)) FROM epidemiologia.staging_dados
WHERE classificacaofinal IS NOT NULL AND TRIM(classificacaofinal) <> ''
ON CONFLICT (nome) DO NOTHING;

INSERT INTO epidemiologia.origem (nome)
SELECT DISTINCT TRIM(LOWER(origem)) FROM epidemiologia.staging_dados
WHERE origem IS NOT NULL AND TRIM(origem) <> ''
ON CONFLICT (nome) DO NOTHING;

INSERT INTO epidemiologia.estrategia_covid (codigo)
SELECT DISTINCT TRIM(codigoestrategiacovid) FROM epidemiologia.staging_dados
WHERE codigoestrategiacovid IS NOT NULL AND TRIM(codigoestrategiacovid) <> ''
ON CONFLICT (codigo) DO NOTHING;

INSERT INTO epidemiologia.laboratorio_primeira_dose (nome)
SELECT DISTINCT TRIM(LOWER(codigolaboratorioprimeiradose)) FROM epidemiologia.staging_dados
WHERE codigolaboratorioprimeiradose IS NOT NULL AND TRIM(codigolaboratorioprimeiradose) <> ''
ON CONFLICT (nome) DO NOTHING;

INSERT INTO epidemiologia.laboratorio_segunda_dose (nome)
SELECT DISTINCT TRIM(LOWER(codigolaboratoriosegundadose)) FROM epidemiologia.staging_dados
WHERE codigolaboratoriosegundadose IS NOT NULL AND TRIM(codigolaboratoriosegundadose) <> ''
ON CONFLICT (nome) DO NOTHING;

INSERT INTO epidemiologia.resultado_teste1 (codigo)
SELECT DISTINCT TRIM(codigoresultadoteste1) FROM epidemiologia.staging_dados
WHERE codigoresultadoteste1 IS NOT NULL AND TRIM(codigoresultadoteste1) <> ''
ON CONFLICT (codigo) DO NOTHING;

-- Dimensões Booleanas (Mapeamento de 1.0 para TRUE)
INSERT INTO epidemiologia.profissional_saude (status)
SELECT DISTINCT (NULLIF(profissionalsaude, '')::NUMERIC = 1) FROM epidemiologia.staging_dados
WHERE profissionalsaude IS NOT NULL AND TRIM(profissionalsaude) <> ''
ON CONFLICT (status) DO NOTHING;

INSERT INTO epidemiologia.profissional_seguranca (status)
SELECT DISTINCT (NULLIF(profissionalseguranca, '')::NUMERIC = 1) FROM epidemiologia.staging_dados
WHERE profissionalseguranca IS NOT NULL AND TRIM(profissionalseguranca) <> ''
ON CONFLICT (status) DO NOTHING;

-- Dimensões Geográficas de Residência (USANDO DISTINCT ON PARA GARANTIR UNICIDADE IBGE/SIGLA)
INSERT INTO epidemiologia.estado (sigla, codigo_ibge)
SELECT DISTINCT ON (codigo_ibge) 
    UPPER(TRIM(estado)) AS sigla, 
    CAST(LEFT(TRIM(municipioibge), 2) AS INTEGER) AS codigo_ibge
FROM epidemiologia.staging_dados
WHERE estado IS NOT NULL AND TRIM(estado) <> '' AND municipioibge IS NOT NULL AND TRIM(municipioibge) <> ''
ON CONFLICT (sigla) DO NOTHING;

INSERT INTO epidemiologia.municipio (nome, codigo_ibge, estado_id)
SELECT DISTINCT
    TRIM(LOWER(t.municipio)),
    CAST(NULLIF(TRIM(t.municipioibge), '')::NUMERIC AS INTEGER), 
    e.estado_id
FROM epidemiologia.staging_dados t
JOIN epidemiologia.estado e ON UPPER(TRIM(t.estado)) = e.sigla 
WHERE t.municipio IS NOT NULL AND TRIM(t.municipio) <> '' AND t.municipioibge IS NOT NULL AND TRIM(t.municipioibge) <> ''
ON CONFLICT (codigo_ibge) DO NOTHING;

-- Dimensões Geográficas de Notificação (USANDO DISTINCT ON PARA GARANTIR UNICIDADE IBGE/SIGLA)
INSERT INTO epidemiologia.estado_notificacao (sigla, codigo_ibge)
SELECT DISTINCT ON (codigo_ibge) 
    UPPER(TRIM(estadonotificacao)) AS sigla, 
    CAST(LEFT(TRIM(municipionotificacaoibge), 2) AS INTEGER) AS codigo_ibge
FROM epidemiologia.staging_dados
WHERE estadonotificacao IS NOT NULL AND TRIM(estadonotificacao) <> '' AND municipionotificacaoibge IS NOT NULL AND TRIM(municipionotificacaoibge) <> ''
ON CONFLICT (sigla) DO NOTHING;

INSERT INTO epidemiologia.municipio_notificacao (nome, codigo_ibge, estado_notificacao_id)
SELECT DISTINCT
    TRIM(LOWER(t.municipionotificacao)),
    CAST(NULLIF(TRIM(t.municipionotificacaoibge), '')::NUMERIC AS INTEGER), 
    en.estado_notificacao_id
FROM epidemiologia.staging_dados t
JOIN epidemiologia.estado_notificacao en ON UPPER(TRIM(t.estadonotificacao)) = en.sigla 
WHERE t.municipionotificacao IS NOT NULL AND TRIM(t.municipionotificacao) <> '' AND t.municipionotificacaoibge IS NOT NULL AND TRIM(t.municipionotificacaoibge) <> ''
ON CONFLICT (codigo_ibge) DO NOTHING;






INSERT INTO epidemiologia.notificacao (
    sexo_id, raca_id, profissional_saude_id, profissional_seguranca_id,
    estado_residencia_id, municipio_residencia_id,
    estado_notificacao_id, municipio_notificacao_id,
    origem_id, evolucao_id, classificacao_id,
    estrategia_id, lab1_id, lab2_id, resultado1_id,
    data_notificacao, data_inicio_sintomas, data_encerramento,
    data_primeira_dose, data_segunda_dose, data_coleta_teste1,
    idade, total_testes, raw_line
)
